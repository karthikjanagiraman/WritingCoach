generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Auth & Identity
// ============================================

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String
  name         String
  role         UserRole     @default(PARENT)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  children ChildProfile[]
}

enum UserRole {
  PARENT
  ADMIN
}

model ChildProfile {
  id          String   @id @default(uuid())
  parentId    String
  parent      User     @relation(fields: [parentId], references: [id])
  name        String
  age         Int
  tier        Int      // Computed from age: 7-9=1, 10-12=2, 13-15=3
  avatarEmoji String   @default("ðŸ¦‰")
  gradeLevel  String?
  interests   String?  // JSON array of writing interests
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lessonProgress     LessonProgress[]
  sessions           Session[]
  assessments        Assessment[]
  writingSubmissions WritingSubmission[]
  placementResult    PlacementResult?
  curriculum         Curriculum?

  @@index([parentId])
}

// ============================================
// Lesson Flow
// ============================================

model LessonProgress {
  id           String    @id @default(uuid())
  childId      String
  lessonId     String
  status       String    @default("not_started")
  currentPhase String?
  startedAt    DateTime?
  completedAt  DateTime?

  child ChildProfile @relation(fields: [childId], references: [id])

  @@unique([childId, lessonId])
  @@index([childId])
}

model Session {
  id                  String   @id @default(uuid())
  childId             String
  lessonId            String
  phase               String   @default("instruction")
  phaseState          String   @default("{}")
  conversationHistory String   @default("[]")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  child              ChildProfile       @relation(fields: [childId], references: [id])
  assessments        Assessment[]
  writingSubmissions WritingSubmission[]

  @@index([childId])
  @@index([childId, lessonId])
}

model Assessment {
  id             String   @id @default(uuid())
  sessionId      String
  childId        String
  lessonId       String
  rubricId       String
  submissionText String
  scores         String
  overallScore   Float
  feedback       String
  createdAt      DateTime @default(now())

  session Session      @relation(fields: [sessionId], references: [id])
  child   ChildProfile @relation(fields: [childId], references: [id])

  @@index([childId])
  @@index([sessionId])
}

// ============================================
// Placement & Curriculum
// ============================================

model PlacementResult {
  id              String   @id @default(uuid())
  childId         String   @unique
  prompts         String   // JSON array of 3 writing prompts
  responses       String   // JSON array of 3 student responses
  aiAnalysis      String   // JSON: { strengths, gaps, reasoning }
  recommendedTier Int
  assignedTier    Int
  confidence      Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  child ChildProfile @relation(fields: [childId], references: [id])
}

enum CurriculumStatus {
  GENERATING
  ACTIVE
  PAUSED
  COMPLETED
}

model Curriculum {
  id             String           @id @default(uuid())
  childId        String           @unique
  status         CurriculumStatus @default(GENERATING)
  weekCount      Int
  lessonsPerWeek Int              @default(3)
  focusAreas     String?          // JSON array of writing type focus areas
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  child     ChildProfile       @relation(fields: [childId], references: [id])
  weeks     CurriculumWeek[]
  revisions CurriculumRevision[]
}

model CurriculumWeek {
  id           String @id @default(uuid())
  curriculumId String
  weekNumber   Int
  theme        String
  lessonIds    String // JSON array of lesson IDs
  status       String @default("pending") // pending | in_progress | completed

  curriculum Curriculum @relation(fields: [curriculumId], references: [id])

  @@unique([curriculumId, weekNumber])
  @@index([curriculumId])
}

model CurriculumRevision {
  id           String   @id @default(uuid())
  curriculumId String
  reason       String   // auto_struggling | auto_excelling | parent_request
  description  String
  previousPlan String   // JSON snapshot of previous week plan
  newPlan      String   // JSON snapshot of new week plan
  createdAt    DateTime @default(now())

  curriculum Curriculum @relation(fields: [curriculumId], references: [id])

  @@index([curriculumId])
}

// ============================================
// Writing Submissions & Feedback
// ============================================

model WritingSubmission {
  id             String   @id @default(uuid())
  sessionId      String
  childId        String
  lessonId       String
  rubricId       String
  submissionText String
  wordCount      Int
  timeSpentSec   Int?
  revisionOf     String?  // ID of the original submission (null for originals)
  revisionNumber Int      @default(0) // 0=original, 1-3=revisions
  createdAt      DateTime @default(now())

  session  Session      @relation(fields: [sessionId], references: [id])
  child    ChildProfile @relation(fields: [childId], references: [id])
  feedback AIFeedback?

  @@index([childId])
  @@index([sessionId])
  @@index([lessonId])
}

model AIFeedback {
  id            String   @id @default(uuid())
  submissionId  String   @unique
  scores        String   // JSON: Record<string, number>
  overallScore  Float
  strength      String
  growthArea    String
  encouragement String
  fullFeedback  String?  // Full AI response text
  model         String   // AI model used, e.g. "claude-sonnet-4-5-20250929"
  createdAt     DateTime @default(now())

  submission WritingSubmission @relation(fields: [submissionId], references: [id])
}
