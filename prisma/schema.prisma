generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Auth & Identity
// ============================================

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String
  name         String
  role         UserRole     @default(PARENT)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  children ChildProfile[]
}

enum UserRole {
  PARENT
  ADMIN
}

model ChildProfile {
  id          String   @id @default(uuid())
  parentId    String
  parent      User     @relation(fields: [parentId], references: [id])
  name        String
  age         Int
  tier        Int      // Computed from age: 7-9=1, 10-12=2, 13-15=3
  avatarEmoji String   @default("ðŸ¦‰")
  gradeLevel  String?
  interests   String?  // JSON array of writing interests
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lessonProgress LessonProgress[]
  sessions       Session[]
  assessments    Assessment[]

  @@index([parentId])
}

// ============================================
// Lesson Flow
// ============================================

model LessonProgress {
  id           String    @id @default(uuid())
  childId      String
  lessonId     String
  status       String    @default("not_started")
  currentPhase String?
  startedAt    DateTime?
  completedAt  DateTime?

  child ChildProfile @relation(fields: [childId], references: [id])

  @@unique([childId, lessonId])
  @@index([childId])
}

model Session {
  id                  String   @id @default(uuid())
  childId             String
  lessonId            String
  phase               String   @default("instruction")
  phaseState          String   @default("{}")
  conversationHistory String   @default("[]")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  child       ChildProfile @relation(fields: [childId], references: [id])
  assessments Assessment[]

  @@index([childId])
  @@index([childId, lessonId])
}

model Assessment {
  id             String   @id @default(uuid())
  sessionId      String
  childId        String
  lessonId       String
  rubricId       String
  submissionText String
  scores         String
  overallScore   Float
  feedback       String
  createdAt      DateTime @default(now())

  session Session      @relation(fields: [sessionId], references: [id])
  child   ChildProfile @relation(fields: [childId], references: [id])

  @@index([childId])
  @@index([sessionId])
}
